<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game History</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #040761 0%, #02006d 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(250, 204, 21, 0.3);
        }

        .header h1 {
            font-size: 28px;
            color: #fde047;
            margin-bottom: 10px;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(250, 204, 21, 0.8);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #fde047;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(250, 204, 21, 0.3);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .filter-group label {
            font-size: 14px;
            color: #fde047;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid rgba(250, 204, 21, 0.5);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 14px;
        }

        .filter-group input[type="date"] {
            padding: 7px 12px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .filter-actions button {
            padding: 8px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-actions button:first-child {
            background: linear-gradient(135deg, #facc15, #d97706);
            color: black;
        }

        .filter-actions button:last-child {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(250, 204, 21, 0.5);
        }

        .filter-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
        }

        .history-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(250, 204, 21, 0.3);
        }

        .section-title {
            font-size: 20px;
            color: #fde047;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(250, 204, 21, 0.3);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(250, 204, 21, 0.2);
            transition: transform 0.3s, border-color 0.3s;
        }

        .history-item:hover {
            transform: translateY(-2px);
            border-color: rgba(250, 204, 21, 0.5);
        }

        .date-header {
            color: #fde047;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-column {
            background: rgba(250, 204, 21, 0.1);
            border-radius: 6px;
            padding: 15px;
            border: 1px solid rgba(250, 204, 21, 0.2);
        }

        .column-label {
            font-size: 18px;
            font-weight: bold;
            color: #fde047;
            margin-bottom: 10px;
        }

        .column-value {
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .time-display {
            text-align: center;
            font-size: 14px;
            color: #d1d5db;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(250, 204, 21, 0.2);
        }

        .time-display strong {
            color: #fde047;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 16px;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #fde047;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #fde047;
            font-size: 16px;
        }

        .loading .spinner {
            border: 3px solid rgba(250, 204, 21, 0.3);
            border-top: 3px solid #fde047;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(250, 204, 21, 0.2);
        }

        .pagination button {
            padding: 8px 16px;
            border-radius: 5px;
            border: 1px solid rgba(250, 204, 21, 0.5);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(250, 204, 21, 0.3);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            align-self: center;
            padding: 0 15px;
            color: #fde047;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            .result-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
                width: 100px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="back-button" onclick="goBack()">‚Üê Back</button>

        <div class="header">
            <h1>OLD RESULTS</h1>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="dateFilter">Date</label>
                <input type="date" id="dateFilter">
            </div>

            <div class="filter-group">
                <label for="columnFilter">Column</label>
                <select id="columnFilter">
                    <option value="">All Columns</option>
                    <option value="A">Column A</option>
                    <option value="B">Column B</option>
                    <option value="C">Column C</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="numberFilter">Number Contains</label>
                <input type="text" id="numberFilter" placeholder="e.g., 53, 72, 91">
            </div>

            <div class="filter-actions">
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>

        <div class="history-container">
            <div class="section-title">Game History</div>

            <div id="historyList" class="history-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading game history...</p>
                </div>
            </div>

            <div id="pagination" class="pagination" style="display: none;">
                <button onclick="changePage(-1)" id="prevBtn">Previous</button>
                <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                <button onclick="changePage(1)" id="nextBtn">Next</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        var state = {
            historyData: [],
            filteredData: [],
            currentPage: 1,
            itemsPerPage: 10,
            currentFilters: {
                date: '',
                column: '',
                number: ''
            }
        };

        // Initialize the page
        function init() {
            loadHistory();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Add enter key support for filters
            document.getElementById('numberFilter').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }

        // Load history from API
        function loadHistory() {
            fetch('http://localhost:8000/api/history')
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(function (result) {
                    console.log('API Response:', result);

                    // Check if API call was successful
                    if (!result.success) {
                        throw new Error(result.error || 'API returned unsuccessful response');
                    }

                    // The data should be in result.data
                    var data = result.data;

                    if (!Array.isArray(data)) {
                        throw new Error('API did not return an array');
                    }

                    // Process the API data to match our display format
                    state.historyData = processApiData(data);
                    state.filteredData = [...state.historyData];
                    renderHistory();
                })
                .catch(function (error) {
                    console.error('Error loading history:', error);
                    showError('Failed to load history data: ' + error.message);
                });
        }

        // Process API data to our display format
        function processApiData(apiData) {
            return apiData.map(function (item) {
                // Use 'time' field instead of 'round_start_time'
                var dateObj = new Date(item.time || item.createdAt);

                // Format date as DD/MM/YYYY for display
                var day = String(dateObj.getDate()).padStart(2, '0');
                var month = String(dateObj.getMonth() + 1).padStart(2, '0');
                var year = dateObj.getFullYear();
                var displayDate = day + '/' + month + '/' + year;
                
                // Also keep YYYY-MM-DD format for filtering
                var filterDate = year + '-' + month + '-' + day;

                // Format time as HH:MM:SS
                var hours = String(dateObj.getHours()).padStart(2, '0');
                var minutes = String(dateObj.getMinutes()).padStart(2, '0');
                var seconds = String(dateObj.getSeconds()).padStart(2, '0');
                var timeStr = hours + ':' + minutes + ':' + seconds;

                // Combine a1 and a2 to get two-digit number for A
                var aValue = String(item.a1) + String(item.a2);
                var bValue = String(item.b1) + String(item.b2);
                var cValue = String(item.c1) + String(item.c2);

                return {
                    originalDate: item.time || item.createdAt,
                    filterDate: filterDate, // YYYY-MM-DD for filtering
                    displayDate: displayDate, // DD/MM/YYYY for display
                    date: displayDate, // Keep for compatibility
                    time: timeStr,
                    A: aValue,
                    B: bValue,
                    C: cValue,
                    // Keep individual values for filtering
                    a1: item.a1,
                    a2: item.a2,
                    b1: item.b1,
                    b2: item.b2,
                    c1: item.c1,
                    c2: item.c2
                };
            }).sort(function (a, b) {
                // Sort by date descending (newest first)
                return new Date(b.originalDate) - new Date(a.originalDate);
            });
        }

        // Apply filters
        function applyFilters() {
            state.currentFilters.date = document.getElementById('dateFilter').value;
            state.currentFilters.column = document.getElementById('columnFilter').value;
            state.currentFilters.number = document.getElementById('numberFilter').value.trim();

            state.filteredData = state.historyData.filter(function (item) {
                var matches = true;

                // Date filter - compare YYYY-MM-DD format
                if (state.currentFilters.date) {
                    // Filter date is already in YYYY-MM-DD format from input
                    matches = matches && (item.filterDate === state.currentFilters.date);
                }

                // Column filter with number search
                if (state.currentFilters.column && state.currentFilters.number) {
                    var columnValue = item[state.currentFilters.column];
                    matches = matches && columnValue.includes(state.currentFilters.number);
                }

                // Number filter (search in all columns)
                if (state.currentFilters.number && !state.currentFilters.column) {
                    matches = matches && (
                        item.A.includes(state.currentFilters.number) ||
                        item.B.includes(state.currentFilters.number) ||
                        item.C.includes(state.currentFilters.number)
                    );
                }

                return matches;
            });

            state.currentPage = 1;
            renderHistory();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('columnFilter').value = '';
            document.getElementById('numberFilter').value = '';

            state.currentFilters = { date: '', column: '', number: '' };
            state.filteredData = [...state.historyData];
            state.currentPage = 1;
            renderHistory();
        }

        // Change page
        function changePage(direction) {
            var newPage = state.currentPage + direction;
            var totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);

            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderHistory();
            }
        }

        // Format date for display - already done in processApiData
        function formatDisplayDate(dateStr) {
            return dateStr; // Already formatted as DD/MM/YYYY
        }

        // Show error message
        function showError(message) {
            var historyList = document.getElementById('historyList');
            historyList.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <p>${message}</p>
                    <p>Please make sure the API server is running at http://localhost:8000</p>
                    <button onclick="loadHistory()" style="margin-top: 15px; padding: 8px 16px; background: #fde047; color: black; border: none; border-radius: 5px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
        }

        // Render history list
        function renderHistory() {
            var historyList = document.getElementById('historyList');
            var pagination = document.getElementById('pagination');

            if (state.filteredData.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <p>No game history found</p>
                        <p>Try adjusting your filters or check back later</p>
                    </div>
                `;
                pagination.style.display = 'none';
                return;
            }

            // Calculate pagination
            var startIndex = (state.currentPage - 1) * state.itemsPerPage;
            var endIndex = startIndex + state.itemsPerPage;
            var pageData = state.filteredData.slice(startIndex, endIndex);
            var totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);

            // Generate HTML
            var html = '';

            pageData.forEach(function (item, index) {
                html += `
                    <div class="history-item">
                        <div class="date-header">${item.displayDate}</div>
                        
                        <div class="result-grid">
                            <div class="result-column">
                                <div class="column-label">A</div>
                                <div class="column-value">${item.A}</div>
                            </div>
                            <div class="result-column">
                                <div class="column-label">B</div>
                                <div class="column-value">${item.B}</div>
                            </div>
                            <div class="result-column">
                                <div class="column-label">C</div>
                                <div class="column-value">${item.C}</div>
                            </div>
                        </div>
                        
                        <div class="time-display">
                            <strong>TIME:</strong> ${item.displayDate} ${item.time}
                        </div>
                    </div>
                `;

                // Add separator line except for last item
                if (index < pageData.length - 1) {
                    html += '<hr style="border: none; border-top: 1px solid rgba(250, 204, 21, 0.2); margin: 20px 0;">';
                }
            });

            historyList.innerHTML = html;

            // Update pagination
            if (state.filteredData.length > state.itemsPerPage) {
                document.getElementById('currentPage').textContent = state.currentPage;
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('prevBtn').disabled = state.currentPage === 1;
                document.getElementById('nextBtn').disabled = state.currentPage === totalPages;
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        }

        // Go back to game
        function goBack() {
            // window.history.back();
            window.location.href = './';
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>